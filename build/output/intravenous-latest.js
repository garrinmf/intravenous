// Intravenous JavaScript library v0.1.4-beta
// (c) Roy Jacobs
// License: MIT (http://www.opensource.org/licenses/mit-license.php)

(function(window,undefined){
function r(g){function u(p,q){for(var k=p.split("."),l=g,n=0;n<k.length-1;n++)l=l[k[n]];l[k[k.length-1]]=q}g="undefined"!==typeof g?g:{};g.version="0.1.4-beta";u("version",g.version);(function(){function p(a,b,d){var c=q(a,b);b=c.key;for(var c=c.data,f,m=a;m&&!(f=m.i[b]);)m=m.parent;if(c&&c.q){var e=c.q(a,b,f);if(e.h)return e.data}if(!m)throw Error("Unknown dependency: "+b);if(c&&c.s&&(e=c.s(a,b,f),e.h))return e.data;if(e=a.c[f.k].get(b))return e;var h;if(f.value instanceof Function){var e=f.value.u,
g={},k=f.value.toString().replace(/((\/\/.*$)|(\/\*[\s\S]*?\*\/)|(\s))/mg,"").match(/^function\s*[^\(]*\(\s*([^\)]*)\)/m)[1].split(/,/);if(1===d.length&&("object"===typeof d[0]||"function"===typeof d[0])&&Object.keys(d[0]).every(function(a){return 0<=k.indexOf(a)})){var l=d.pop();Object.keys(l).forEach(function(a){g[a]=l[a]})}!e&&0>=d.length&&(e=k,""===e[0]&&(e=null));h=[];if(e instanceof Array)for(c=0,m=e.length;c<m;c++){var s=e[c];g[s]?h.push(g[s]):h.push(p(a,s,[]))}c=function(){};c.prototype=f.value.prototype;
e=new c;c=0;for(m=d.length;c<m;c++)h.push(d[c]);h=f.value.apply(e,h);if(h instanceof Function){e=new n(a,b);e.a.register(b,h);for(var t in h)h.hasOwnProperty(t)&&(e[t]=h[t]);h=void 0}}else e=f.value;a.c[f.k].set(new y(f,e));return h||e}function q(a,b){for(var d in a.r)for(var c=a.r[d],f=0,g=c.suffixes.length;f<g;f++){var e=c.suffixes[f];if(-1!==b.indexOf(e,b.length-e.length))return{data:c,key:b.slice(0,b.length-e.length)}}return{data:null,key:b}}function k(a,b){this.i={};this.parent=b;this.c={perRequest:new v(this),
singleton:new w(this,b?b.c.singleton:null),unique:new x(this)};this.children=[];this.options=a=a||{};this.register("container",this);this.dispose=this.f;this.get=this.get;this.register=this.register}function l(a,b){this.a=a;this.key=b;this.dispose=this.f;this.get=this.get;this.use=this.j}function n(a,b){this.a=a.create();this.key=b;this.dispose=this.f;this.get=this.get;this.use=this.j}function x(a){this.a=a;this.b=[]}function w(a,b){this.a=a;this.b=[];this.e={};this.parent=b}function v(a){this.a=
a;this.b=[];this.e={};this.tag=0;this.n={};this.o=[]}function y(a,b){this.d=a;this.g=b}function z(a,b,d,c){this.key=a;this.a=b;this.value=d;this.k=c}v.prototype={get:function(a){for(var b=0,d=this.b.length;b<d;b++){var c=this.b[b];if(c.d.key===a&&c.tag===this.tag){if(!c.g)break;this.set(c);return c.g}}this.o.push(a);if(this.n[a])throw Error("Circular reference: "+this.o.join(" --\x3e "));this.n[a]=!0;return null},set:function(a){this.b.push(a);a.tag=this.tag;this.e[a.tag]=this.e[a.tag]||{};this.e[a.tag][a.d.key]=
this.e[a.tag][a.d.key]++||1},l:function(a){return!--this.e[a.tag][a.d.key]},m:function(){this.tag++;this.n={};this.o=[]}};w.prototype={get:function(a){for(var b=0,d=this.b.length;b<d;b++){var c=this.b[b];if(c.d.key===a){if(!c.g)break;this.set(c);return c.g}}return this.parent?this.parent.get(a):null},set:function(a){this.b.push(a);this.e[a.d.key]=this.e[a.d.key]++||1},l:function(a){return!--this.e[a.d.key]},m:function(){}};x.prototype={get:function(){return null},set:function(a){this.b.push(a)},l:function(){return!0},
m:function(){}};n.prototype={get:function(){var a=Array.prototype.slice.call(arguments);a.unshift(this.key);a=this.a.get.apply(this.a,a);a.p=this;return a},j:function(a,b,d){this.a.register(a,b,d);return this},f:function(){this.a.f()}};l.prototype={get:function(){var a=new n(this.a,this.key);return a.get.apply(a,arguments)},j:function(a,b,d){return(new n(this.a,this.key)).j(a,b,d)},f:function(a){a.p.f();delete a.p}};k.prototype={r:{w:{suffixes:["?"],q:function(a,b,d){return d?{h:!1}:{h:!0,data:null}}},
v:{suffixes:["Factory","!"],s:function(a,b){return{h:!0,data:new l(a,b)}}}},register:function(a,b,d){if(q(this,a).data)throw Error("Cannot register dependency: "+a);!d&&this.i[a]?this.i[a].value=b:this.i[a]=new z(a,this,b,d||"perRequest")},get:function(a){for(var b in this.c)this.c.hasOwnProperty(b)&&this.c[b].m(a);b=Array.prototype.slice.call(arguments).slice(1);for(var d=this,c;d&&null===(c=p(d,a,b));)d=d.parent;return c},f:function(){for(var a;a=this.children.pop();)a.f();for(var b=this.t();a=
b.pop();)if(this.c[a.d.k].l(a)&&this.options.onDispose)this.options.onDispose(a.g,a.d.key);return!0},create:function(a){a=a||{};a.onDispose=a.onDispose||this.options.onDispose;a=new k(a,this);this.children.push(a);return a},t:function(){var a=[],b;for(b in this.c)this.c.hasOwnProperty(b)&&(a=a.concat(this.c[b].b));return a}};g.create=function(a){return new k(a)};u("create",g.create)})()}
"function"===typeof require&&"object"===typeof exports&&"object"===typeof module?r(module.exports||exports):"function"===typeof define&&define.amd?define(["exports"],r):r(window.intravenous={});!0;
})(typeof window !== "undefined" ? window : global);
